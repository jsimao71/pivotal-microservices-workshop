:compat-mode:
= Lab 6 - Binding to Cloud Foundry Services

[abstract]
--
The _Spring Music_ application was designed to illustrate the ease with which various types of data services can be bound to and utilized by Spring applications running on Cloud Foundry.
In this lab, we'll be binding the application to both MySql and MongoDB databases.

Cloud Foundry services are managed through two primary types of operations:

Create/Delete:: These operations create or delete instances of a service.
For a database this could mean creating/deleting a schema in an existing multitenant cluster or creating/deleting a dedicated database cluster.
Bind/Unbind:: These operations create or delete unique credential sets for an existing service instance that can then be injected into the environment of an application instance.
--

== A Bit of Review

Your instance of _Spring Music_ should still be running from the end of link:../lab_05/lab_05.adoc[Lab 5].
Visit the application in your browser by hitting the route that was generated by the CLI:

image::../../../Common/images/Spring_Music_NS.png[]

The information dialog in the top right-hand corner indicates that we're currently running with an in-memory database, and that we're not bound to any services.
Let's change that.

== The Services Marketplace

There are two ways to discover what services are available when using Pivotal Cloud Foundry (PCF):

 . The first is available on _any_ instance of Cloud Foundry (Open Source or PCF) via the `cf` CLI.
Type:
+
----
$ cf marketplace
----
+
and you'll get a list of services, their available plans, and descriptions (the services list may vary
from what we show here):
+
----
instructor$ cf marketplace
Getting services from marketplace in org pivotaledu / space development as pchapman@gopivotal.com...
OK

service          plans                                                   description   
3scale           free_appdirect, basic_appdirect*, pro_appdirect*        API Management Platform   
app-autoscaler   bronze, gold                                            Scales bound applications in response to load (beta)   
blazemeter       free-tier, basic1kmr*, pro5kmr*                         Performance Testing Platform   
cleardb          spark, boost*, amp*, shock*                             Highly available MySQL for your Apps.   
...
----

 . The second way is specific to PCF's Application Manager UI.  If using Pivotal Web Services
(PWS), this is what you see once you login to http://run.pivotal.io. If you haven't already,
login now.  
+
Click on the ``Marketplace'' link (on the left hand side panel):
_The Screenshots below are from PWS (public managed Pivotal CF).
If you are using your own installation of PCF, you will see something similar._
+
image::../../../Common/images/PWS_AM_InstructorSpace.png[]
+
and you'll see the same service/plan/description listing in the browser:
+
image::../../../Common/images/PWS_Marketplace.png[]

== Creating and Binding to a Service Instance

. Let's begin by creating a MySql instance provided by Pivotal.
+
From the CLI, let's _create_ a `p-mysql` service instance:
+
----
$ cf create-service p-mysql 100mb-dev spring-music-db 
Creating service spring-music-db in org CNA / space instructor as mstine@pivotal.io...
OK
----
+
If `p-mysql` is not an available service, use `cleardb` instead (select the free `spark` plan:
`cf create-service cleardb spark spring-music-db`).

. Next we'll _bind_ the newly created instance to our `spring-music` application:
+
----
$ cf bs spring-music spring-music-db
Binding service spring-music-db to app spring-music in org ACME / space instructor as mstine@pivotal.io...
OK
TIP: Use 'cf restage' to ensure your env variable changes take effect
----

. Notice the admonition to `Use 'cf restage' to ensure your env variable changes take effect`.
Let's take a look at the environment variables for our application to see what's been done. We can do this by typing:
+
----
$ cf env spring-music
----
+
The subset of the output we're interested in is located near the very top, titled `System-Provided`:
+
====
----
System-Provided:
{
 "VCAP_SERVICES": { <1>
  "p-mysql": [
   {
    "credentials": {
     "hostname": "10.68.50.61",
     "jdbcUrl": "jdbc:mysql://10.68.50.61:3306/cf_ddbe0221_d1fc_478f_b693_69279b2de702?user=mWsYAON34zbaQPAA\u0026password=CZImCZ9iSNU7HfP2",
     "name": "cf_ddbe0221_d1fc_478f_b693_69279b2de702",
     "password": "CZImCZ9iSNU7HfP2",
     "port": 3306,
     "uri": "mysql://mWsYAON34zbaQPAA:CZImCZ9iSNU7HfP2@10.68.50.61:3306/cf_ddbe0221_d1fc_478f_b693_69279b2de702?reconnect=true", <2>
     "username": "mWsYAON34zbaQPAA"
    },
    "label": "p-mysql",
    "name": "spring-music-db",
    "plan": "100mb-dev",
    "tags": [
     "mysql",
     "relational"
    ]
   }
  ]
 }
}

{
 "VCAP_APPLICATION": {
  "application_name": "spring-music",
  "application_uris": [
   "spring-music-unbragging-pourparler.pcf2.fe.gopivotal.com"
  ],
  "application_version": "e3fa423d-69ad-41cb-bd17-0e88427dfe4c",
  "limits": {
   "disk": 1024,
   "fds": 16384,
   "mem": 512
  },
  "name": "spring-music",
  "space_id": "080ba4e6-bafc-482b-9a98-42f612eef736",
  "space_name": "jfullam",
  "uris": [
   "spring-music-unbragging-pourparler.pcf2.fe.gopivotal.com"
  ],
  "users": null,
  "version": "e3fa423d-69ad-41cb-bd17-0e88427dfe4c"
 }
}
----
<1> `VCAP_SERVICES` is a special Cloud Foundry environment variable that contains a JSON document containing all of the information for any services bound to an application.
<2> Notice here the unique URI for this instance of MySql that `spring-music` has been bound to.
====

. Now let's _restage_ the application, which cycles our application back through the staging/buildpack process before redeploying the application.footnote:[In this case, we could accomplish the same goal by only _restarting_ the application via `cf restart spring-music`.
A _restage_ is generally recommended because Cloud Foundry buildpacks also have access to injected environment variables and can install or configure things differently based on their values.]
+
----
$ cf restage spring-music
----
+
Once the application is running again, revisit or refresh the browser tab where you have the _Spring Music_ application loaded:
+
image::../../../Common/images/Spring_Music_PGSQL.png[]
+
Click on the `(i)` symbol at top-right and it will drop down the information dialog.  You should be able to see that
the application is now utilizing a MySql database via the `spring-music-db` service.
+
*Note:* If the application hasn't picked up the `spring-music-db` service, try doing a complete `cf push` again.

. *(OPTIONAL STEPS)* If you have a MySql GUI tool handy and you are using a lab environment that has the necessary network access (ask your instructor), you can inspect the music database created. Otherwise, your instructor will demo via a Pivotal VPN connection.

. In your DB tool, create a new server connection and populate the properties with values from the URI in your `VCAP_SERVICES` environment variable (remember `cf env spring-muisc`!):

== Optional: Swapping from MySql to MongoDB

Only do this next section if you have sufficient time.

. Now let's bind our _Spring Music_ application to MongoDB instead of MySql. First let's create footnote:[Notice in this listing that we're typing `cf cs` rather than `cf create-service`.
Most CF CLI commands have a shorthand version to save typing time.
You can view these shorthand commands via `cf help` or `cf h` (See! More shorthand!).] a MongoDB instance from the Pivotal Cloud Foundry marketplace:
+
----
$ cf cs p-mongodb development spring-music-mongo 
Creating service spring-music-mongo in org ACME / space instructor as mstine@pivotal.io...
OK
----
+
If you do not have the `p-mongodb` service available use `mongolab` and choose the `sandbox` plan:
`cf cs mongolab sandbox spring-music-mongo`.

. Next we'll unbind our application from our MySql instance (_Spring Music_ does not support being bound to multiple datasources at the same time):
+
----
$ cf us spring-music spring-music-db
----
+
If you visit your application now, you'll see that it still works.
If you recall, environment variable changes (such as binding/unbinding of services) don't actually take effect until a _restage_ or _restart_.

. Now let's bind the application to our MongoDB instance:
+
----
$ cf bs spring-music spring-music-mongo
Binding service spring-music-mongo to app spring-music in org oreilly-class / space instructor as mstine@pivotal.io...
OK
TIP: Use 'cf restage' to ensure your env variable changes take effect
----

. And then do a restage:
+
----
$ cf restage spring-music
----

+
Once the application is running again, revisit or refresh the browser tab where you have the _Spring Music_ application loaded:
+
image::../../../Common/images/Spring_Music_Mongo.png[]
+
As you can see from the information dialog, the application is now utilizing a MongoDB database via the `spring-music-mongo` service.

. *(OPTIONAL)* Similar to the steps to view the relational data in another DB tool, a MongoDB client tool can be used to inspect the MongoDB instance.  Your instructor can demo this if you do not have access to the tool and / or the appropriate network access to the MongoDB instance.

== Clean Up

Because of the limited PWS quota we have for this course, let's clean up our application and services to make room for future labs.

. Delete the `spring-music` application:
+
----
$ cf d spring-music

Really delete the app spring-music?> y
Deleting app spring-music in org oreilly-class / space instructor as mstine@pivotal.io...
OK
----

. If you did the optional section using MongoDB, delete the `spring-music-mongo` service:
+
----
$ cf ds spring-music-mongo

Really delete the service spring-music-mongo?> y
Deleting service spring-music-mongo in org oreilly-class / space instructor as mstine@pivotal.io...
OK
----

. Delete the `spring-music-db` service:
+
----
$ cf ds spring-music-db

Really delete the service spring-music-db?> y
Deleting service spring-music-db in org oreilly-class / space instructor as mstine@pivotal.io...
OK
----
